# Инструкция по настройке авторизации через ВКонтакте

## Что было добавлено

1. **Конфигурационные файлы:**
   - `config/vk_config.php` - конфигурация VK ID приложения
   - `config/db.php` - подключение к БД через PDO для работы с пользователями

2. **Файлы авторизации:**
   - `auth/login.php` - страница входа с адаптированным дизайном SONGLY
   - `auth/vk_callback.php` - обработчик callback от VK ID
   - `auth/logout.php` - выход из системы
   - `auth/check_auth.php` - проверка авторизации пользователя

3. **База данных:**
   - `database_users_setup.sql` - SQL-скрипт для создания таблиц пользователей и сессий

4. **Обновленные страницы:**
   - `index.php` - добавлена кнопка "Войти" и отображение имени пользователя
   - `singers_list.php`, `songs_list.php`, `singer.php`, `text_song.php` - добавлен общий хедер с авторизацией
   - `includes/header.php` - общий хедер для всех страниц
   - `css/main.css` - добавлены стили для кнопки входа и имени пользователя

## Шаги для настройки

### 1. Настройка базы данных

Выполните SQL-скрипт для создания необходимых таблиц:

```bash
mysql -u root -p j27119254_song < database_users_setup.sql
```

Или через phpMyAdmin:
1. Откройте phpMyAdmin
2. Выберите базу данных `j27119254_song`
3. Перейдите на вкладку "SQL"
4. Скопируйте содержимое файла `database_users_setup.sql` и выполните

### 2. Настройка приложения ВКонтакте

1. Перейдите на [vk.com/apps?act=manage](https://vk.com/apps?act=manage)
2. Создайте новое приложение или используйте существующее
3. В настройках приложения:
   - **Тип приложения:** Веб-сайт
   - **Адрес сайта:** `https://songbooks.asmart-test-dev.ru`
   - **Базовый домен:** `songbooks.asmart-test-dev.ru`
   - **Доверенный redirect URI:** `https://songbooks.asmart-test-dev.ru/auth/vk_callback.php`

4. Скопируйте **ID приложения** и **Защищённый ключ**

### 3. Обновление конфигурации

Откройте файл `config/vk_config.php` и замените значения:

```php
define('VK_APP_ID', 52860889); // Замените на ваш ID приложения
define('VK_APP_SECRET', 'ваш_защищенный_ключ'); // Замените на ваш защищённый ключ
```

### 4. Проверка директорий

Убедитесь, что директория для загрузки фотографий существует и имеет права на запись:

```bash
mkdir -p uploads/photos
chmod 755 uploads/photos
```

### 5. Тестирование

1. Откройте сайт: `https://songbooks.asmart-test-dev.ru`
2. Нажмите кнопку "Войти" в шапке
3. Авторизуйтесь через ВКонтакте
4. После успешной авторизации вы будете перенаправлены на главную страницу
5. В шапке должно отображаться ваше имя и значок выхода (✕)

## Как это работает

1. Пользователь нажимает "Войти" и переходит на `auth/login.php`
2. Страница загружает VK ID SDK и отображает виджет авторизации
3. После авторизации VK ID возвращает токен и данные пользователя
4. `vk_callback.php` обрабатывает данные:
   - Создаёт нового пользователя в БД или обновляет существующего
   - Создаёт сессию с токеном
   - Сохраняет информацию в PHP сессии
5. Пользователь редиректится на главную страницу
6. На всех страницах через `includes/header.php` проверяется авторизация и отображается имя пользователя

## Безопасность

- Все SQL-запросы используют prepared statements
- Пароли не хранятся (авторизация только через VK ID)
- Сессии имеют срок действия 30 дней
- XSS-защита через `htmlspecialchars()`
- Проверка токенов сессий в базе данных

## Структура базы данных

### Таблица `users`
- `id` - уникальный ID пользователя
- `username` - имя пользователя (генерируется автоматически)
- `vk_id` - ID пользователя ВКонтакте
- `vk_access_token` - токен доступа VK
- `first_name`, `last_name` - имя и фамилия
- `profile_photo` - путь к фото профиля
- Дополнительные поля: email, date_of_birth, gender, city, bio

### Таблица `user_sessions`
- `id` - уникальный ID сессии
- `user_id` - связь с пользователем
- `session_token` - токен сессии (64 символа)
- `expires_at` - время истечения сессии
- `ip_address`, `user_agent` - информация о клиенте

## Дополнительная настройка

### Изменение времени жизни сессии

В файле `auth/vk_callback.php` найдите строку:

```php
$expires_at = date('Y-m-d H:i:s', strtotime('+30 days'));
```

Измените `+30 days` на нужное значение (например, `+7 days`, `+1 hour`).

### Настройка внешнего вида

Стили для авторизации находятся в:
- `auth/login.php` - встроенные стили страницы входа
- `css/main.css` - стили для кнопки входа и имени пользователя в шапке

## Устранение неполадок

### Ошибка "Ошибка подключения к базе данных"
- Проверьте настройки в `config/db.php`
- Убедитесь, что база данных существует и доступна

### Не отображается виджет VK ID
- Проверьте правильность VK_APP_ID в `config/vk_config.php`
- Откройте консоль браузера (F12) и проверьте ошибки JavaScript

### Пользователь не остаётся авторизованным
- Проверьте, что таблица `user_sessions` создана
- Убедитесь, что PHP сессии работают корректно
- Проверьте, что `session_start()` вызывается на всех страницах

### Ошибка redirect_uri_mismatch
- Убедитесь, что в настройках VK приложения указан правильный Redirect URI
- URI должен точно совпадать с `VK_REDIRECT_URI` в `config/vk_config.php`
